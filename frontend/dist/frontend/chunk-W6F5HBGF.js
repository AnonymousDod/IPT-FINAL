import{b as G}from"./chunk-5RCUSW7M.js";import{a as H,b as w}from"./chunk-7FSPOTPR.js";import{Ha as B,c as R,d as I,da as M,g as V,h as z,i as C,l as F,m as k,o as p}from"./chunk-AFLXQZBF.js";import{a as D,b as x}from"./chunk-2XJVAMHT.js";function le(n){return()=>new Promise(b=>{localStorage.getItem("currentUser")?n.refreshToken().subscribe({next:()=>{console.log("Token refreshed successfully"),b()},error:s=>{console.error("Token refresh failed:",s),s.status!==401&&n.logout(),b()}}):b()})}var he=(()=>{class n{constructor(a){this.accountService=a}intercept(a,s){return s.handle(a).pipe(V(i=>{[401,403].includes(i.status)&&this.accountService.accountValue&&this.accountService.logout();let c=i&&i.error&&i.error.message||i.statusText;return console.error(i),I(c)}))}static{this.\u0275fac=function(s){return new(s||n)(p(w))}}static{this.\u0275prov=k({token:n,factory:n.\u0275fac})}}return n})();var g=function(n){return n.User="User",n.Admin="Admin",n}(g||{});var d="angular-18-signup-verification-boilerplate-accounts",o=localStorage.getItem(d)?JSON.parse(localStorage.getItem(d)):[],Oe=(()=>{class n{constructor(a){this.alertService=a}intercept(a,s){let{url:i,method:c,headers:P,body:h}=a,L=()=>{try{switch(!0){case(i.endsWith("/accounts/authenticate")&&c==="POST"):return Q();case(i.endsWith("/accounts/refresh-token")&&c==="POST"):return X();case(i.endsWith("/accounts/revoke-token")&&c==="POST"):return Z();case(i.endsWith("/accounts/register")&&c==="POST"):return K();case(i.endsWith("/accounts/verify-email")&&c==="POST"):return q();case(i.endsWith("/accounts/forgot-password")&&c==="POST"):return Y();case(i.endsWith("/accounts/validate-reset-token")&&c==="POST"):return _();case(i.endsWith("/accounts/reset-password")&&c==="POST"):return ee();case(i.endsWith("/accounts")&&c==="GET"):return te();case(i.match(/\/accounts\/\d+$/)&&c==="GET"):return re();case(i.endsWith("/accounts")&&c==="POST"):return ne();case(i.match(/\/accounts\/\d+$/)&&c==="PUT"):return oe();case(i.match(/\/accounts\/\d+$/)&&c==="DELETE"):return ie();default:return s.handle(a)}}catch{return m("An unexpected error occurred")}},K=()=>{let e=h;return o.find(t=>t.email===e.email)?(setTimeout(()=>{this.alertService.info(`<h4>Email Already Registered</h4>
            <p>Your email ${e.email} is already registered.</p>
            <p>If you don't know your password please visit the <a href="${location.origin}/account/forgot-password">forgot password</a> page.</p>
            <div><strong>NOTE:</strong> The fake backend displayed this "email" so you can test without an api. A real backend would send a real email.</div>`,{autoClose:!1})},1e3),u()):(e.id=J(),e.role=e.id===1?g.Admin:g.User,e.dateCreated=new Date().toISOString(),e.verificationToken=new Date().getTime().toString(),e.isVerified=!1,e.refreshTokens=[],delete e.confirmPassword,o.push(e),localStorage.setItem(d,JSON.stringify(o)),setTimeout(()=>{let t=`${location.origin}/account/verify-email?token=${e.verificationToken}`;this.alertService.info(`
          <h4>Verification Email</h4>
          <p>Thanks for registering!</p>
          <p>Please click the below link to verify your email address:</p>
          <a href="${t}">${t}</a>
          <div><strong>NOTE:</strong> The fake backend displayed this "email" so you can test without an api. A real backend would send a real email.</div>
        `,{autoclose:!1})},1e3),u())},Y=()=>{let{email:e}=h,t=o.find(f=>f.email===e);if(!t)return u();t.resetToken=new Date().getTime().toString(),t.resetTokenExpires=new Date(Date.now()+24*60*60*1e3).toISOString(),localStorage.setItem(d,JSON.stringify(o));let r=`${location.origin}/account/reset-password?token=${t.resetToken}`;return setTimeout(()=>{this.alertService.info(`
          <div>
            <h4>Reset Password Email</h4>
            <p>Please click the below link to reset your password, the link will be valid for 1 day:</p>
            <p><a href="${r}">${r}</a></p>
            <p><strong>NOTE:</strong> The fake backend displayed this "email" so you can test without an api. A real backend would send a real email.</p>
          </div>
        `,1e4)}),u()};return L().pipe(F(),z(500),C());function Q(){let{email:e,password:t}=h;if(!e||!t)return m("Email and password are required");let r=o.find(T=>T.email===e);if(!r)return m("Email or password is incorrect");if(!r.isVerified)return m("Account not verified");if(r.password!==t)return m("Email or password is incorrect");r.refreshTokens=r.refreshTokens.filter(T=>{let E=JSON.parse(atob(T.split(".")[1]));return Date.now()<E.exp*1e3});let f=U();return r.refreshTokens.push(f),localStorage.setItem(d,JSON.stringify(o)),u(x(D({},S(r)),{jwtToken:$(r),refreshToken:f}))}function X(){let e=W();if(!e)return l();let t=JSON.parse(atob(e.split(".")[1]));if(Date.now()>t.exp*1e3)return l();let r=o.find(f=>f.refreshTokens.includes(e));return r?(r.refreshTokens=r.refreshTokens.filter(f=>f!==e),r.refreshTokens.push(U()),localStorage.setItem(d,JSON.stringify(o)),u(x(D({},S(r)),{jwtToken:$(r)}))):l()}function Z(){if(!v())return l();let e=W(),t=o.find(r=>r.refreshTokens.includes(e));return t.refreshTokens=t.refreshTokens.filter(r=>r!==e),localStorage.setItem(d,JSON.stringify(o)),localStorage.removeItem("currentUser"),localStorage.removeItem("refreshToken"),u()}function q(){let{token:e}=h,t=o.find(r=>r.verificationToken&&r.verificationToken===e);return t?(t.isVerified=!0,localStorage.setItem(d,JSON.stringify(o)),u()):m("Verification failed")}function _(){let{token:e}=h;return o.find(r=>r.resetToken&&r.resetToken===e&&new Date<new Date(r.resetTokenExpires))?u():m("Invalid token")}function ee(){let{token:e,password:t}=h,r=o.find(f=>!!f.resetToken&&f.resetToken===e&&new Date<new Date(f.resetTokenExpires));return r?(r.password=t,r.isVerified=!0,delete r.resetToken,delete r.resetTokenExpires,localStorage.setItem(d,JSON.stringify(o)),u()):m("Invalid token")}function te(){return v()?u(o.map(e=>S(e))):l()}function re(){if(!v())return l();let e=o.find(t=>t.id===A());return e.id!==y().id&&!O(g.Admin)?l():u(S(e))}function ne(){if(!O(g.Admin))return l();let e=h;return o.find(t=>t.email===e.email)?m(`Email ${e.email} is already registered`):(e.id=J(),e.dateCreated=new Date().toISOString(),e.isVerified=!0,e.refreshTokens=[],delete e.confirmPassword,o.push(e),localStorage.setItem(d,JSON.stringify(o)),u())}function oe(){if(!v())return l();let e=h,t=o.find(r=>r.id===A());return t.id!==y().id&&!O(g.Admin)?l():(e.password||delete e.password,delete e.confirmPassword,Object.assign(t,e),localStorage.setItem(d,JSON.stringify(o)),u(S(t)))}function ie(){return!v()||o.find(t=>t.id===A()).id!==y().id&&!O(g.Admin)?l():(o=o.filter(t=>t.id!==A()),localStorage.setItem(d,JSON.stringify(o)),u())}function u(e){return R(new M({status:200,body:e}))}function m(e){return I({error:{message:e}})}function l(){return I({status:401,error:{message:"Unauthorized"}})}function S(e){let{id:t,title:r,firstName:f,lastName:T,email:E,role:ae,dateCreated:se,isVerified:ce}=e;return{id:t,title:r,firstName:f,lastName:T,email:E,role:ae,dateCreated:se,isVerified:ce}}function v(){return!!y()}function O(e){let t=y();return t?t.role===e:!1}function A(){let e=i.split("/");return parseInt(e[e.length-1])}function J(){return o.length?Math.max(...o.map(e=>e.id))+1:1}function y(){try{let e=P.get("Authorization");if(!e?.startsWith("Bearer "))return null;let t=e.split(" ")[1],r=JSON.parse(atob(t.split(".")[1]));return Date.now()>r.exp*1e3?null:o.find(T=>T.id===r.id)||null}catch{return null}}function $(e){let t={exp:Math.round(new Date(Date.now()+9e5).getTime()/1e3),iat:Math.round(Date.now()/1e3),id:e.id,role:e.role};return`fake-jwt-token.${btoa(JSON.stringify(t))}`}function U(){let e={exp:Math.round(new Date(Date.now()+6048e5).getTime()/1e3),iat:Math.round(Date.now()/1e3)};return`fake-refresh-token.${btoa(JSON.stringify(e))}`}function W(){return(document.cookie.split(";").find(e=>e.includes("fakeRefreshToken"))||"=").split("=")[1]}}static{this.\u0275fac=function(s){return new(s||n)(p(G))}}static{this.\u0275prov=k({token:n,factory:n.\u0275fac})}}return n})();var Ee=(()=>{class n{constructor(a){this.accountService=a}intercept(a,s){let i=this.accountService.accountValue,c=i&&i.jwtToken,P=a.url.startsWith(H.apiUrl);return c&&P&&(a=a.clone({setHeaders:{Authorization:`Bearer ${i.jwtToken}`}})),s.handle(a)}static{this.\u0275fac=function(s){return new(s||n)(p(w))}}static{this.\u0275prov=k({token:n,factory:n.\u0275fac})}}return n})();var Ne=(()=>{class n{constructor(a,s){this.router=a,this.accountService=s}canActivate(a,s){let i=this.accountService.accountValue;return i?a.data.roles&&!a.data.roles.includes(i.role)?(this.router.navigate(["/"]),!1):!0:(this.router.navigate(["/account/login"],{queryParams:{returnUrl:s.url}}),!1)}static{this.\u0275fac=function(s){return new(s||n)(p(B),p(w))}}static{this.\u0275prov=k({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();export{le as a,Ne as b,he as c,g as d,Oe as e,Ee as f};
